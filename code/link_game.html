<!DOCTYPE html>
<meta charset="utf-8">
<style>

    circle {
      stroke-width: 1.5px;
    }

    line {
        stroke: #181818;
        stroke-width: 3px;
    }

.button {
  background-color: #4CAF50;
  border: none;
  color: white;
  padding-top: 16px;
  padding-bottom: 16px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 2em;
  /*margin: 4px 2px;*/
  -webkit-transition-duration: 0.4s; /* Safari */
  transition-duration: 0.4s;
  cursor: pointer;
  background-color: white;
  color: black;
  border: 2px solid #4CAF50;

  width: 100%;
}

.button:hover {
  background-color: #4CAF50;
  color: white;
}

body {
    font-family: arial;
}

image {
  image-rendering: pixelated;
  image-rendering: -moz-crisp-edges;
  image-rendering: crisp-edges;
}

</style>
<body>

<!-- https://stackoverflow.com/questions/2637696/how-to-place-div-side-by-side -->
<!-- TODO : Mettre les styles dans la balise style au début du fichier. Fuck le CSS. -->
<div style="width: 100%; display: table;">
    <div style="
  padding: 10px; overflow: ; display: table-row;">
        <div class="svg-container" style="
display: table-cell;
width: 75%;
  /* border: 3px solid blue; */
  padding: 10px;">

        </div>
        <div style="
  /* border: 3px solid #73AD21; */
  padding: 10px; display: table-cell; vertical-align: top; background-color: lightgray;">

            <div class="descrip-person" style="padding: 0.5em; font-size: 1.2em;"></div>
            <div style="  margin: auto;
  width: 50%; ">
                <div class="button associate">Associer</div>
            </div>
            <div class="descrip-itm" style="padding: 0.5em; font-size: 1.2em;"></div>

        </div>
    </div>
</div>

<script src="d3.js"></script>
<script>

    const PERSON = 0;
    const ITEM = 1;

    // inspirations :
    // Labeled Force Layout https://bl.ocks.org/mbostock/950642
    // Bounded Force Layout https://bl.ocks.org/mbostock/1129492
    // Modifying a Force Layout https://bl.ocks.org/mbostock/1095795

    dict_nodes = {

        "person_fighter": ["Guerrier / guerrière", PERSON, "person_fighter.png"],
        "person_mage": ["Mage", PERSON, "person_mage.png"],
        "person_thief": ["Voleur / Voleuse", PERSON, "person_thief.png"],
        "person_cleric": ["Prêtre / Prêtresse", PERSON, "person_cleric.png"],
        "person_pala": ["Paladin / Paladine", PERSON, "person_pala.png"],
        "obj_longsword": ["Épée longue", ITEM, "obj_longsword.png"],
        "obj_robes": ["Robe", ITEM, "obj_robe.png"],
        "obj_spell_book": ["Livre de sorts", ITEM, "obj_spell_book.png"],
        "obj_holy_symbol": ["Symbole sacré", ITEM, "obj_holy_symbol.png"],
        "obj_pala_grail": ["Symbole sacré (paladin)", ITEM, "obj_pala_grail.png"],
    }

    // C'est un peu dégueux, parce qu'on se retrouve avec les données en triple,
    // dans dict_nodes, dict_nodes_processed et init_nodes. Eh bien voilà, pas mieux.
    dict_nodes_processed = {}

    init_nodes = []

    for (var key in dict_nodes) {
        var name = dict_nodes[key][0]
        var img = dict_nodes[key][2]
        new_node = { "node_id": key, "name": name, "img": "img/"+img }
        init_nodes.push(new_node)
        dict_nodes_processed[key] = new_node
    }

    answers = [
        ["person_fighter", "obj_longsword", false],
        ["person_mage", "obj_robes", false],
        ["person_fighter", "obj_robes", false],
        ["person_thief", "obj_robes", false],
        ["person_mage", "obj_spell_book", false],
        ["person_cleric", "obj_holy_symbol", false],
        ["person_pala", "obj_pala_grail", false],
    ]

    selected_person = null;
    selected_item = null;

    function init_force_layout() {

        graph = {
            "nodes": init_nodes,
            "links": [],
        }

        // http://www.sebarmeli.com/blog/2010/12/06/best-way-to-loop-through-an-array-in-javascript/
        // https://stackoverflow.com/questions/3010840/loop-through-an-array-in-javascript#3010848
        // C'est une blague ? Il faut lire deux articles et envisager 6 façons de faire pour boucler sur un tableau ?
        // C'est quoi ce langage ?
        for (var answer of answers) {
            if (answer[2]) {
                graph["links"].push({source: dict_nodes_processed[answer[0]], target: dict_nodes_processed[answer[1]], value: 1})
            }
        }

        width = 960
        height = 500
        radius = 6

        var fill = d3.scale.category20()

        var force = d3.layout.force()
            .gravity(.05)
            .charge(-240)
            .linkDistance(120)
            .size([width, height])

        // https://stackoverflow.com/questions/11942500/how-to-make-force-layout-graph-in-d3-js-responsive-to-screen-browser-size
        var svg = d3.select(".svg-container").append("svg")
            .attr("viewBox", "0 0 " + width + " " + height)

        link = svg.selectAll("line")
            .data(graph.links)
            .enter().append("line")

        node = svg.selectAll("circle")
            .data(graph.nodes)
            .enter().append("g")
            .attr("name", function(d) { return d.name })
            .attr("node_id", function(d) { return d.node_id })
            .call(force.drag)

        node.append("image")
            //.attr("xlink:href", "silver_key.png")
            .attr("xlink:href", function(d) { return d.img })
            .attr("x", -25)
            .attr("y", -25)
            .attr("width", 50)
            .attr("height", 50)

        node.append("text")
            .attr("dx", 27)
            .attr("dy", ".35em")
            .text(function(d) { return d.name })

        force.nodes(graph.nodes)
            .links(graph.links)
            .on("tick", tick)
            .start()


        node.on("click", function() {

            var selected_node_id = d3.select(this).attr('node_id')
            var selected_node_infos = dict_nodes[selected_node_id]

            if (selected_node_infos == null) {
                return
            }
            if (selected_node_infos[1] == PERSON) {
                // WLA TODO : html entities
                d3.select(".descrip-person").html("Personne sélectionnée : " + selected_node_infos[0] + "<br><br>(Bla bla description personne).")
                selected_person = selected_node_id
            }
            else if (selected_node_infos[1] == ITEM) {
                // WLA TODO : html entities
                d3.select(".descrip-itm").html("Item sélectionné : " + selected_node_infos[0] + "<br><br>(Bla bla description item).")
                selected_item = selected_node_id
            }

        })

    }

    function tick() {
        node.attr("cx", function(d) { return d.x = Math.max(radius, Math.min(width - radius, d.x)) })
            .attr("cy", function(d) { return d.y = Math.max(radius, Math.min(height - radius, d.y)) })

        link.attr("x1", function(d) { return d.source.x })
            .attr("y1", function(d) { return d.source.y })
            .attr("x2", function(d) { return d.target.x })
            .attr("y2", function(d) { return d.target.y })

        node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")" })
    }

    d3.select(".associate").on("click", function () {

        var must_refresh = false
        if (selected_person == null) {
            return
        }
        if (selected_item == null) {
            return
        }

        for (var answer of answers) {
            // Désolé pour la condition dégueux à rallonge.
            if ((answer[2] == false) && (
                ((answer[0] == selected_person) && (answer[1] == selected_item)) || ((answer[1] == selected_person) && (answer[0] == selected_item))
            )) {
                answer[2] = true
                must_refresh = true
            }
        }

        if (must_refresh) {
            d3.select("svg").remove()
            // Donc là, on repète tout le graphe pour le reconstruire de zéro. C'est méga-bourrin, mais apparamment ça marche.
            init_force_layout()
        }


    })

    init_force_layout()

</script>
</body>